Sub ExportVulnerabilitesVersExcel_Exist()

    Dim xl As Object
    Dim wb As Object
    Dim ws As Object
    Dim p As Paragraph
    Dim txt As String
    Dim ligne As Long
    
    ' Variables Word
    Dim Titre As String
    Dim Resume As String
    Dim Description As String
    Dim Criticite As String
    Dim DateEmission As String
    
    Dim section As String
    
    ' Ouvrir Excel existant
    Set xl = CreateObject("Excel.Application")
    xl.Visible = True
    Set wb = xl.Workbooks.Open("C:\Ton\Chemin\suivi_vulnerabilites.xlsx")
    Set ws = wb.Sheets(1)
    
    ' Trouver la 1ère ligne vide
    ligne = ws.Cells(ws.Rows.Count, 1).End(-4162).Row + 1   ' -4162 = xlUp
    
    ' Parcourir Word
    For Each p In ActiveDocument.Paragraphs
        
        txt = Trim(p.Range.Text)
        If txt = "" Then GoTo NextLoop
        
        ' Détection du titre de vulnérabilité
        If InStr(txt, "Vulnérabilité") > 0 Then
            ' Si une vulnérabilité précédente existe → on la sauvegarde
            If Titre <> "" Then
                ws.Cells(ligne, 1).Value = Titre
                ws.Cells(ligne, 2).Value = Description
                ws.Cells(ligne, 3).Value = Criticite
                ws.Cells(ligne, 4).Value = DateEmission
                ligne = ligne + 1
            End If
            
            ' Initialisation nouvelle vulnérabilité
            Titre = txt
            Resume = ""
            Description = ""
            Criticite = ""
            DateEmission = ""
        
        ' Extraction de la date
        ElseIf LCase(Left(txt, 5)) = "date:" Then
            DateEmission = Trim(Replace(txt, "Date:", "", , , vbTextCompare))
        
        ' Résumé → contient le nom CVE / nom vulnérabilité
        ElseIf LCase(Left(txt, 6)) = "résumé" Then
            section = "resume"
        
        ' Risques → peut contenir criticité dans certains rapports
        ElseIf LCase(Left(txt, 6)) = "risque" Then
            section = "risques"
        
        ElseIf InStr(LCase(txt), "criticité") > 0 Then
            Criticite = Replace(txt, "Criticité :", "")
        
        ' Version affectée, rarement utile ici
        ElseIf InStr(LCase(txt), "version affectée") > 0 Then
            section = "ignore"
        
        ElseIf LCase(Left(txt, 11)) = "description" Then
            section = "description"
        
        ElseIf LCase(Left(txt, 14)) = "recommandation" Then
            section = "ignore"
        
        ' Contenu des sections
        Else
            Select Case section
                Case "resume"
                    Resume = Resume & " " & txt
                    ' On prend le nom CVE / nom vulnérabilité depuis le résumé
                    If ws.Cells(ligne, 1).Value = "" Then
                        Titre = txt
                    End If
                
                Case "description"
                    Description = Description & " " & txt
                
                Case "risques"
                    ' si criticité mentionnée ici
                    If InStr(LCase(txt), "high") Or InStr(LCase(txt), "medium") Or InStr(LCase(txt), "low") Then
                        Criticite = txt
                    End If
            End Select
        
        End If

NextLoop:
    Next p
    
    ' Sauver la dernière vulnérabilité
    If Titre <> "" Then
        ws.Cells(ligne, 1).Value = Titre
        ws.Cells(ligne, 2).Value = Description
        ws.Cells(ligne, 3).Value = Criticite
        ws.Cells(ligne, 4).Value = DateEmission
    End If
    
    MsgBox "Export terminé !", vbInformation

End Sub
